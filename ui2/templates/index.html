<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gimbal & Camera Control</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            background: #1a1a1a;
            color: #fff;
            padding: 10px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 1fr 350px;
            gap: 20px;
            height: 100vh;
        }

        .video-section {
            background: #2a2a2a;
            border-radius: 8px;
            padding: 20px;
            display: flex;
            flex-direction: column;
        }

        .video-container {
            flex: 1;
            background: #000;
            border-radius: 8px;
            overflow: hidden;
            position: relative;
        }

        #videoStream {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        .controls-section {
            background: #2a2a2a;
            border-radius: 8px;
            padding: 20px;
            overflow-y: auto;
        }

        .control-group {
            margin-bottom: 25px;
            padding: 15px;
            background: #333;
            border-radius: 8px;
        }

        .control-group h3 {
            margin-bottom: 15px;
            color: #4CAF50;
            font-size: 16px;
        }

        .gimbal-pad {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 5px;
            margin-bottom: 15px;
        }

        .gimbal-btn {
            padding: 15px;
            background: #4CAF50;
            border: none;
            border-radius: 4px;
            color: white;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.2s;
        }

        .gimbal-btn:hover {
            background: #45a049;
        }

        .gimbal-btn:active {
            background: #3d8b40;
        }

        .gimbal-btn.center {
            background: #f44336;
        }

        .gimbal-btn.center:hover {
            background: #da190b;
        }

        .zoom-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .zoom-btn {
            flex: 1;
            padding: 12px;
            background: #2196F3;
            border: none;
            border-radius: 4px;
            color: white;
            cursor: pointer;
            font-size: 14px;
        }

        .zoom-btn:hover {
            background: #1976D2;
        }

        .slider-group {
            margin-bottom: 15px;
        }

        .slider-group label {
            display: block;
            margin-bottom: 5px;
            font-size: 12px;
            color: #ccc;
        }

        .slider {
            width: 100%;
            height: 4px;
            border-radius: 2px;
            background: #555;
            outline: none;
            appearance: none;
        }

        .slider::-webkit-slider-thumb {
            appearance: none;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #4CAF50;
            cursor: pointer;
        }

        .select-group {
            margin-bottom: 15px;
        }

        .select-group label {
            display: block;
            margin-bottom: 5px;
            font-size: 12px;
            color: #ccc;
        }

        select {
            width: 100%;
            padding: 8px;
            background: #444;
            border: 1px solid #555;
            border-radius: 4px;
            color: white;
            font-size: 12px;
        }

        .action-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .action-btn {
            padding: 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: background 0.2s;
        }

        .capture-btn {
            background: #FF9800;
            color: white;
        }

        .capture-btn:hover {
            background: #F57C00;
        }

        .record-btn {
            background: #f44336;
            color: white;
        }

        .record-btn:hover {
            background: #d32f2f;
        }

        .record-btn.recording {
            background: #ff1744;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }

        .status {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 10px 15px;
            border-radius: 4px;
            font-size: 12px;
            z-index: 1000;
            transition: all 0.3s;
        }

        .status.success {
            background: #4CAF50;
            color: white;
        }

        .status.error {
            background: #f44336;
            color: white;
        }

        .status.hidden {
            opacity: 0;
            transform: translateY(-20px);
        }

        @media (max-width: 768px) {
            .container {
                grid-template-columns: 1fr;
                grid-template-rows: 60vh auto;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="video-section">
            <div class="video-container">
                <video id="videoStream" autoplay muted controls>
                    <source src="{{ webrtc_url }}" type="application/x-mpegURL">
                    브라우저가 비디오를 지원하지 않습니다.
                </video>
            </div>
        </div>

        <div class="controls-section">
            <!-- 짐벌 제어 -->
            <div class="control-group">
                <h3>짐벌 제어</h3>
                <div class="gimbal-pad">
                    <button class="gimbal-btn" data-direction="up-left">↖</button>
                    <button class="gimbal-btn" data-direction="up">↑</button>
                    <button class="gimbal-btn" data-direction="up-right">↗</button>
                    <button class="gimbal-btn" data-direction="left">←</button>
                    <button class="gimbal-btn center" data-direction="stop">STOP</button>
                    <button class="gimbal-btn" data-direction="right">→</button>
                    <button class="gimbal-btn" data-direction="down-left">↙</button>
                    <button class="gimbal-btn" data-direction="down">↓</button>
                    <button class="gimbal-btn" data-direction="down-right">↘</button>
                </div>
                
                <div class="slider-group">
                    <label>Yaw: <span id="yawValue">0</span>°</label>
                    <input type="range" class="slider" id="yawSlider" min="-180" max="180" value="0">
                </div>
                
                <div class="slider-group">
                    <label>Pitch: <span id="pitchValue">0</span>°</label>
                    <input type="range" class="slider" id="pitchSlider" min="-90" max="90" value="0">
                </div>
                
                <button class="action-btn capture-btn" onclick="resetGimbal()">리셋</button>
            </div>

            <!-- 카메라 줌 -->
            <div class="control-group">
                <h3>줌 제어</h3>
                <div class="zoom-controls">
                    <button class="zoom-btn" onclick="zoomControl('out')">줌 아웃</button>
                    <button class="zoom-btn" onclick="zoomControl('in')">줌 인</button>
                </div>
                
                <div class="slider-group">
                    <label>줌 레벨: <span id="zoomValue">50</span>%</label>
                    <input type="range" class="slider" id="zoomSlider" min="0" max="100" value="50">
                </div>
            </div>

            <!-- 카메라 설정 -->
            <div class="control-group">
                <h3>카메라 설정</h3>
                <div class="select-group">
                    <label>뷰 소스</label>
                    <select id="viewSource">
                        <option value="0">EO/IR 통합</option>
                        <option value="1">EO</option>
                        <option value="2">IR</option>
                        <option value="3">전환</option>
                        <option value="4">동기화</option>
                    </select>
                </div>
                
                <div class="select-group">
                    <label>IR 팔레트</label>
                    <select id="irPalette">
                        <option value="1">화이트핫</option>
                        <option value="2">블랙핫</option>
                        <option value="3">레인보우</option>
                        <option value="4">아이언보우</option>
                        <option value="5">라바</option>
                        <option value="6">아틱</option>
                        <option value="7">글로우보우</option>
                        <option value="8">그레이드</option>
                        <option value="9">히트</option>
                        <option value="10">용접</option>
                    </select>
                </div>
                
                <div class="select-group">
                    <label>OSD 모드</label>
                    <select id="osdMode">
                        <option value="0">끄기</option>
                        <option value="1">디버그</option>
                        <option value="2">상태정보</option>
                    </select>
                </div>
            </div>

            <!-- 캡처/녹화 -->
            <div class="control-group">
                <h3>캡처 & 녹화</h3>
                <div class="action-buttons">
                    <button class="action-btn capture-btn" onclick="captureImage()">이미지 캡처</button>
                    <button class="action-btn record-btn" id="recordBtn" onclick="toggleRecord()">녹화 시작</button>
                </div>
            </div>
        </div>
    </div>

    <div class="status hidden" id="status"></div>

    <script>
        let isRecording = false;
        let gimbalMoveInterval = null;

        // 상태 메시지 표시
        function showStatus(message, type = 'success') {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = `status ${type}`;
            setTimeout(() => {
                status.className = 'status hidden';
            }, 3000);
        }

        // API 호출 헬퍼
        async function apiCall(endpoint, data = {}) {
            try {
                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                const result = await response.json();
                
                if (result.status === 'success') {
                    showStatus(result.message, 'success');
                } else {
                    showStatus(result.message, 'error');
                }
                return result;
            } catch (error) {
                showStatus(`오류: ${error.message}`, 'error');
                return { status: 'error', message: error.message };
            }
        }

        // 짐벌 제어
        const gimbalDirections = {
            'up': { yaw: 0, pitch: -10, roll: 0 },
            'down': { yaw: 0, pitch: 10, roll: 0 },
            'left': { yaw: -10, pitch: 0, roll: 0 },
            'right': { yaw: 10, pitch: 0, roll: 0 },
            'up-left': { yaw: -7, pitch: -7, roll: 0 },
            'up-right': { yaw: 7, pitch: -7, roll: 0 },
            'down-left': { yaw: -7, pitch: 7, roll: 0 },
            'down-right': { yaw: 7, pitch: 7, roll: 0 },
            'stop': { yaw: 0, pitch: 0, roll: 0 }
        };

        // 짐벌 패드 이벤트
        document.querySelectorAll('.gimbal-btn').forEach(btn => {
            btn.addEventListener('mousedown', (e) => {
                const direction = e.target.getAttribute('data-direction');
                const movement = gimbalDirections[direction];
                
                if (direction === 'stop') {
                    stopGimbal();
                } else {
                    startGimbalMove(movement);
                }
            });

            btn.addEventListener('mouseup', () => {
                if (gimbalMoveInterval) {
                    stopGimbal();
                }
            });

            btn.addEventListener('mouseleave', () => {
                if (gimbalMoveInterval) {
                    stopGimbal();
                }
            });
        });

        function startGimbalMove(movement) {
            stopGimbal(); // 기존 움직임 중지
            apiCall('/api/gimbal/continuous-move', movement);
            
            // 연속 제어를 위한 간격 설정
            gimbalMoveInterval = setInterval(() => {
                apiCall('/api/gimbal/continuous-move', movement);
            }, 100);
        }

        function stopGimbal() {
            if (gimbalMoveInterval) {
                clearInterval(gimbalMoveInterval);
                gimbalMoveInterval = null;
            }
            apiCall('/api/gimbal/continuous-move', { yaw: 0, pitch: 0, roll: 0 });
        }

        function resetGimbal() {
            stopGimbal();
            apiCall('/api/gimbal/reset');
        }

        // 슬라이더 제어
        const yawSlider = document.getElementById('yawSlider');
        const pitchSlider = document.getElementById('pitchSlider');
        const yawValue = document.getElementById('yawValue');
        const pitchValue = document.getElementById('pitchValue');

        yawSlider.addEventListener('input', (e) => {
            yawValue.textContent = e.target.value;
            apiCall('/api/gimbal/position-move', {
                yaw: parseFloat(e.target.value),
                pitch: parseFloat(pitchSlider.value),
                roll: 0
            });
        });

        pitchSlider.addEventListener('input', (e) => {
            pitchValue.textContent = e.target.value;
            apiCall('/api/gimbal/position-move', {
                yaw: parseFloat(yawSlider.value),
                pitch: parseFloat(e.target.value),
                roll: 0
            });
        });

        // 줌 제어
        function zoomControl(direction) {
            const zoomDirection = direction === 'in' ? 1 : -1;
            apiCall('/api/camera/zoom/continuous', { zoomDirection });
        }

        const zoomSlider = document.getElementById('zoomSlider');
        const zoomValue = document.getElementById('zoomValue');

        zoomSlider.addEventListener('input', (e) => {
            zoomValue.textContent = e.target.value;
            apiCall('/api/camera/zoom/range', { zoomPercentage: parseInt(e.target.value) });
        });

        // 카메라 설정 변경
        document.getElementById('viewSource').addEventListener('change', (e) => {
            apiCall('/api/camera/view-source', { viewSrc: parseInt(e.target.value) });
        });

        document.getElementById('irPalette').addEventListener('change', (e) => {
            apiCall('/api/camera/ir-palette', { irPalette: parseInt(e.target.value) });
        });

        document.getElementById('osdMode').addEventListener('change', (e) => {
            apiCall('/api/camera/osd-mode', { osdMode: parseInt(e.target.value) });
        });

        // 캡처 & 녹화
        function captureImage() {
            apiCall('/api/camera/capture-image');
        }

        function toggleRecord() {
            const recordBtn = document.getElementById('recordBtn');
            
            if (!isRecording) {
                apiCall('/api/camera/start-record').then(result => {
                    if (result.status === 'success') {
                        isRecording = true;
                        recordBtn.textContent = '녹화 중지';
                        recordBtn.classList.add('recording');
                    }
                });
            } else {
                apiCall('/api/camera/stop-record').then(result => {
                    if (result.status === 'success') {
                        isRecording = false;
                        recordBtn.textContent = '녹화 시작';
                        recordBtn.classList.remove('recording');
                    }
                });
            }
        }

        // 키보드 단축키
        document.addEventListener('keydown', (e) => {
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'SELECT') return;
            
            const keyActions = {
                'ArrowUp': () => startGimbalMove(gimbalDirections.up),
                'ArrowDown': () => startGimbalMove(gimbalDirections.down),
                'ArrowLeft': () => startGimbalMove(gimbalDirections.left),
                'ArrowRight': () => startGimbalMove(gimbalDirections.right),
                'KeyW': () => startGimbalMove(gimbalDirections.up),
                'KeyS': () => startGimbalMove(gimbalDirections.down),
                'KeyA': () => startGimbalMove(gimbalDirections.left),
                'KeyD': () => startGimbalMove(gimbalDirections.right),
                'Space': () => { e.preventDefault(); stopGimbal(); },
                'KeyR': () => resetGimbal(),
                'Equal': () => zoomControl('in'),
                'Minus': () => zoomControl('out')
            };

            if (keyActions[e.code]) {
                e.preventDefault();
                keyActions[e.code]();
            }
        });

        document.addEventListener('keyup', (e) => {
            if (['ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight', 'KeyW', 'KeyS', 'KeyA', 'KeyD'].includes(e.code)) {
                stopGimbal();
            }
        });

        // 페이지 종료 시 짐벌 정지
        window.addEventListener('beforeunload', () => {
            stopGimbal();
        });

        // 비디오 스트림 로드 오류 처리
        document.getElementById('videoStream').addEventListener('error', (e) => {
            showStatus('비디오 스트림 연결 실패', 'error');
        });
    </script>
</body>
</html>